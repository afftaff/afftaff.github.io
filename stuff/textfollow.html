<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Text Pair Reader</title>
    <style>
        /* Basic Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
            padding: 10px;
            font-size: 16px;
            resize: vertical;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        #displayArea {
            display: none;
            background-color: #fff;
            padding: 30px;
            border-radius: 5px;
            min-height: 100px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            max-height: 600px;
            overflow-y: auto;
        }
        .sentence-pair {
            display: none;
        }
        .active-sentence {
            display: block;
        }
        .line-pair {
            margin-bottom: 10px;
        }
        .original {
            font-size: 20px;
            margin-bottom: 5px;
            color: #000;
            white-space: pre-wrap;
        }
        .translated {
            font-size: 16px;
            /* Spotlight Effect Styles */
            color: rgba(0, 0, 0, 1);
            position: relative;
            --x: -9999px;
            --y: -9999px;
            -webkit-mask-image: radial-gradient(circle 100px at var(--x) var(--y), black 0%, transparent 100%);
            mask-image: radial-gradient(circle 100px at var(--x) var(--y), black 0%, transparent 100%);
            white-space: pre-wrap;
        }
        #instructions {
            margin-top: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            color: #888;
        }
        .nav-buttons {
            text-align: center;
            margin-top: 20px;
        }
        .nav-buttons button {
            margin: 0 10px;
        }
        /* Hide the translated textarea by default */
        #translatedText {
            display: none;
        }
        /* Style for the expand button */
        #expandTranslationButton {
            cursor: pointer;
            display: inline-block;
            margin-left: 10px;
            color: blue;
            text-decoration: underline;
        }
        /* Styles for the API Key input */
        #apiKeyContainer {
            margin-bottom: 20px;
        }
        #apiKeyContainer label {
            font-size: 16px;
            margin-right: 10px;
        }
        #apiKeyInput {
            width: calc(100% - 100px);
            padding: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        #toggleApiKeyButton {
            padding: 8px 12px;
            font-size: 16px;
            cursor: pointer;
        }
        #apiKeyHeader {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        #apiKeyHeader span {
            font-size: 16px;
            margin-right: 10px;
        }
        /* New styles for the words and phrases list */
        #wordsPhrasesContainer {
            display: none;
            background-color: #fff;
            padding: 30px;
            border-radius: 5px;
            min-height: 100px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .word-phrase-item {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }
        #restartButton {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        /* Styles for the Matching Game */
        .matching-game {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        .original-list {
            width: 100%;
        }
        .original-item {
            margin-bottom: 15px;
        }
        .original-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .select-translation {
            width: 100%;
            padding: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .correct {
            background-color: #c8e6c9 !important;
        }
        .incorrect {
            background-color: #ffcdd2 !important;
        }
        #guessButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #result {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        /* New Styles for Test Button */
        #useTestButton {
            margin-left: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
        }

        /* Styles for the Quiz */
        #quizContainer {
            display: none;
            background-color: #f0f8ff;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .quiz-question {
            margin-bottom: 15px;
        }

        .quiz-question p {
            font-weight: bold;
        }

        .quiz-chunk {
            margin-bottom: 20px;
        }

        .quiz-question select,
        .quiz-question input {
            width: 100%;
            padding: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        #submitQuizButton {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .feedback {
            margin-top: 10px;
            font-weight: bold;
        }

        .correct-answer {
            color: green;
        }

        .incorrect-answer {
            color: red;
        }

        /* Styles for Attempt Indicators */
        .attempt-indicator {
            font-size: 14px;
            color: #555;
            margin-top: 5px;
        }

        /* Styles for Revealing Correct Answers */
        .correct-answer-text {
            font-size: 14px;
            color: green;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Text Pair Reader</h1>
        <div id="inputArea">
            <!-- API Key Input -->
            <div id="apiKeyContainer">
                <div id="apiKeyHeader">
                    <label for="apiKeyInput">API Key:</label>
                    <button id="toggleApiKeyButton">[-]</button>
                </div>
                <input type="password" id="apiKeyInput" placeholder="Enter your API key here..." />
            </div>

            <!-- Textarea for Original Text -->
            <textarea id="originalText" placeholder="Paste original text here..."></textarea>

            <!-- Buttons -->
            <button id="translateAndGoButton">Translate & Go</button>
            <button id="useTestButton">Use Test Sentences</button>
            <button id="goButton" style="display: none;">Go</button>
        </div>
        <!-- Display Area for Showing Text Pairs and Quiz -->
        <div id="displayArea">
            <div id="instructions">
                Use Left & Right arrow keys or navigation buttons to navigate through the text.
            </div>
            <!-- Container for all sentence pairs -->
            <div id="sentencesContainer"></div>
            <!-- Quiz Container -->
            <div id="quizContainer"></div>
            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button id="prevButton">Previous</button>
                <button id="nextButton">Next</button>
            </div>
        </div>

        <!-- New container to display words and phrases -->
        <div id="wordsPhrasesContainer">
            <h2>Matching Game: Match the Words and Phrases</h2>
            <div class="matching-game">
                <div class="original-list">
                    <h3>Original Terms</h3>
                    <div id="originalList"></div>
                </div>
            </div>
            <button id="guessButton">Guess</button>
            <div id="result"></div>
            <button id="restartButton">Restart</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const apiKeyInput = document.getElementById('apiKeyInput');
        const toggleApiKeyButton = document.getElementById('toggleApiKeyButton');
        const apiKeyContainer = document.getElementById('apiKeyContainer');
        const originalTextArea = document.getElementById('originalText');
        const translateAndGoButton = document.getElementById('translateAndGoButton');
        const goButton = document.getElementById('goButton');
        const displayArea = document.getElementById('displayArea');
        const sentencesContainer = document.getElementById('sentencesContainer');
        const inputArea = document.getElementById('inputArea');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const wordsPhrasesContainer = document.getElementById('wordsPhrasesContainer');
        const originalList = document.getElementById('originalList');
        const guessButton = document.getElementById('guessButton');
        const resultDiv = document.getElementById('result');
        const restartButton = document.getElementById('restartButton');
        const useTestButton = document.getElementById('useTestButton'); // Added Test Button

        // New Quiz Container
        const quizContainer = document.getElementById('quizContainer');

        // Variables to store sentences and current index
        let sentencePairs = [];
        let currentIndex = 0;

        // New variable to store extracted words and phrases
        let wordsAndPhrases = [];

        // New variable to store quiz data
        let quizData = null;

        // Variables to track attempts and correctness
        let attemptCounts = [];
        let correctAnswers = [];

        // Initialize a Set to store selected translations
        const selectedTranslations = new Set();

        // Initialize apiKey from localStorage
        let apiKey = '';

        // ------------------------- Added Test Sentences ------------------------- //

        // Predefined Test Sentences (Original in French and Translated in English)
        const testSentencesOriginal = [
            "Le français est une langue romane riche en histoire.",
            "Paris est la capitale de la France.",
            "La littérature française est renommée mondialement.",
            "La Tour Eiffel est un symbole emblématique de Paris.",
            "Le français est parlé par des millions de personnes dans le monde.",
            "La cuisine française est appréciée pour sa diversité.",
            "La langue française a influencé de nombreuses autres langues.",
            "Les films français sont reconnus pour leur qualité artistique."
        ];

        const testSentencesTranslated = [
            "French is a Romance language rich in history.",
            "Paris is the capital of France.",
            "French literature is renowned worldwide.",
            "The Eiffel Tower is an iconic symbol of Paris.",
            "French is spoken by millions of people around the world.",
            "French cuisine is appreciated for its diversity.",
            "The French language has influenced many other languages.",
            "French films are recognized for their artistic quality."
        ];

        /**
         * Function to handle the "Use Test Sentences" button click event.
         */
        function handleUseTestSentences() {
            // Combine test sentences into single string separated by new lines
            const originalText = testSentencesOriginal.join('\n');

            // Populate the text areas
            originalTextArea.value = originalText;

            // Save to localStorage
            saveToLocalStorage(originalText); // Only original text is saved

            // Proceed to 'Go' action
            goButton.click();
        }

        // ------------------------- End of Test Sentences Section ------------------------- //

        /**
         * Load saved texts and API key from localStorage when the page loads.
         */
        window.onload = function() {
            const originalLocal = localStorage.getItem('originalText');
            const apiKeyLocal = localStorage.getItem('apiKey');
            if (originalLocal) {
                originalTextArea.value = originalLocal;
            }
            if (apiKeyLocal) {
                apiKeyInput.value = apiKeyLocal;
                apiKey = apiKeyLocal;
                // Minimize the API key input
                apiKeyInput.style.display = 'none';
                toggleApiKeyButton.textContent = '[+]';
            } else {
                // Show the API key input
                apiKeyInput.style.display = 'block';
                toggleApiKeyButton.textContent = '[-]';
            }
        }

        /**
         * Function to save the API key and original text to localStorage.
         * @param {string} original - Original text.
         */
        function saveToLocalStorage(original) {
            localStorage.setItem('originalText', original);
            localStorage.setItem('apiKey', apiKey);
        }

        /**
         * Function to make a single API call to process and translate the text.
         * @param {string} text - The original text to process and translate.
         * @returns {Promise<Array>} - The JSON object containing sentences and their translations.
         */
        async function translateAndProcessText(text) {
            if (!apiKey) {
                throw new Error('API Key is missing. Please enter your API key.');
            }

            // API Endpoint
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${apiKey}`;

            // System Instruction as per user requirements
            const systemInstruction = `
Get me each sentence. split every 70 characters. do not break words.


Give me the sentence and lines in this format just put translation value as N/A:

  sentences: [
  {
    "sentenceID": 1,
    "lines": [
      {
        "original": "Ceci est la première phrase, qui rentre dans soixante-dix caractères",
		"translated": "N/A"
      }
    ]
  },
  {
    "sentenceID": 2,
    "lines": [
      {
        "original": "La deuxième phrase est beaucoup plus longue et doit être divisée sur",
		"translated": "N/A"
      },
      {
        "original": "deux lignes pour tenir dans soixante-dix caractères",
		"translated": "N/A"
      }
    ]
  },
  {
    "sentenceID": 3,
    "lines": [
      {
        "original": "Il est également important de noter que certaines phrases peuvent",
		"translated": "N/A"
      },
      {
        "original": "contenir des mots ou des expressions plus complexes qui nécessitent",
		"translated": "N/A"
      },
      {
        "original": "une attention particulière lors de la traduction.",
		"translated": "N/A"
      }
    ]
  }
]

            `;

            // Construct the request payload
            const requestBody = {
                "contents": [
                    {
                        "role": "user",
                        "parts": [
                            {
                                "text": text
                            }
                        ]
                    }
                ],
                "systemInstruction": {
                    "role": "user",
                    "parts": [
                        {
                            "text": systemInstruction
                        }
                    ]
                },
                "generationConfig": {
                    "temperature": 0.7,
                    "topK": 50,
                    "topP": 0.95,
                    "maxOutputTokens": 1500,
                    "responseMimeType": "application/json"
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error.message}`);
                }

                const data = await response.json();

                // Extract the JSON response from the API
                const responseText = data.candidates[0].content.parts[0].text;

                // Parse the JSON string
                let parsedJSON;
                try {
                    parsedJSON = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Error parsing JSON:', parseError);
                    throw new Error('Failed to parse JSON response from API.');
                }

                return parsedJSON;
            } catch (error) {
                console.error('Error during translation and processing:', error);
                throw error;
            }
        }

        /**
         * Function to extract words and phrases using the API.
         * @param {string} text - The original text.
         * @returns {Promise<Array>} - An array of word and phrase pairs.
         */
        async function extractWordsAndPhrases(text) {
            if (!apiKey) {
                throw new Error('API Key is missing. Please enter your API key.');
            }

            // API Endpoint
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

            // Construct the request payload with your specified system instruction
            const requestBody = {
                "contents": [
                    {
                        "role": "user",
                        "parts": [
                            {
                                "text": text
                            }
                        ]
                    }
                ],
                "systemInstruction": {
                    "role": "user",
                    "parts": [
                        {
                            "text": "Give me 8 words (or as much as there is) and 3 phrases (or as much as there is) from this the text and translate them to English then write out each one like this [étoile | star]. No formatting and do not respond with anything else other than the [ | ]."
                        }
                    ]
                },
                "generationConfig": {
                    "temperature": 1,
                    "topK": 64,
                    "topP": 0.95,
                    "maxOutputTokens": 8192,
                    "responseMimeType": "text/plain"
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error.message}`);
                }

                const data = await response.json();

                // Extract the response text
                const responseText = data.candidates[0].content.parts[0].text;

                // Parse the response text into an array
                const pairs = responseText.match(/\[.*?\]/g).map(item => item.slice(1, -1));

                return pairs;
            } catch (error) {
                console.error('Error during extraction:', error);
                throw error;
            }
        }

        /**
         * Function to make the API call to generate quiz questions.
         * @param {string} sentence - The current sentence to generate quiz questions for.
         * @returns {Promise<Array>} - The quiz questions as an array.
         */
        async function getQuizQuestions(sentence) {
            if (!apiKey) {
                throw new Error('API Key is missing. Please enter your API key.');
            }

            // API Endpoint
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

            // System Instruction for quiz generation
            const systemInstruction = `
"Create quiz questions for any provided sentence in French, Spanish, German, or any other language specified. Analyze the sentence's structure, meaning, and grammatical elements, breaking it into meaningful chunks. Develop multiple-choice and fill-in-the-blank questions focused on grammatical roles, specific word usage, and general meaning of each segment.

For multiple-choice questions, include one correct answer along with several plausible incorrect options. For fill-in-the-blank questions, users should identify or input specific words from the sentence. Each question should include question_translation for any grammatical terms used, facilitating understanding across languages.

Output should be in JSON format, detailing the chunk being questioned, the question in the original language, its English translation under question_translation, the type of question (dropdown for multiple choice or input for written answers), and the list of answers.

Example Input: "Given sentence: 'Le renard brun rapide saute par-dessus le chien paresseux.' Language: French"

Example Output JSON Structure: 
{
  "questions": [
    {
      "chunk": "Le renard brun rapide",
      "question": "Quel est le sujet de la phrase?",
      "question_translation": "What is the subject of the sentence?",
      "type": "dropdown",
      "answers": [
        { "answer": "saute", "correct": false },
        { "answer": "le chien paresseux", "correct": false },
        { "answer": "Le renard brun rapide", "correct": true },
        { "answer": "par-dessus le chien paresseux", "correct": false }
      ]
    },
    {
      "chunk": "saute par-dessus",
      "question": "Quel type de phrase est 'saute par-dessus'?",
      "question_translation": "What kind of phrase is 'saute par-dessus'?",
      "type": "dropdown",
      "answers": [
        { "answer": "Adverbial phrase (Phrase adverbiale)", "correct": false },
        { "answer": "Verb and preposition (Verbe et préposition)", "correct": true },
        { "answer": "Adjective phrase (Phrase adjectivale)", "correct": false },
        { "answer": "Noun phrase (Groupe nominal)", "correct": false }
      ]
    },
    {
      "chunk": "le chien paresseux",
      "question": "Identifiez l'article et l'adjectif dans ce segment.",
      "question_translation": "Identify the article and adjective in this chunk.",
      "type": "dropdown",
      "answers": [
        { "answer": "le", "correct": true },
        { "answer": "chien", "correct": false},
        { "answer": "paresseux", "correct": true }
      ]
    }
  ]
}

Instructions: "Replace the 'Given sentence' and 'Language' with any sentence and specify the language for which a quiz is to be generated. Use the example output as a template to structure the JSON, adjusting the questions to fit the grammatical and semantic elements unique to the specified language."

Please don't make the first answer the correct one every time!"
            `;

            const requestBody = {
                "contents": [
                    {
                        "role": "user",
                        "parts": [
                            {
                                "text": sentence
                            }
                        ]
                    }
                ],
                "systemInstruction": {
                    "role": "user",
                    "parts": [
                        {
                            "text": systemInstruction
                        }
                    ]
                },
                "generationConfig": {
                    "temperature": 0.7,
                    "topK": 50,
                    "topP": 0.95,
                    "maxOutputTokens": 1500,
                    "responseMimeType": "application/json"
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error.message}`);
                }

                const data = await response.json();

                // Debug: Log the raw API response
                console.log('API Response:', data);

                // Extract the quiz JSON from the API response directly
                const quizJSON = data.candidates[0].content.parts[0].text;

                // Debug: Log the raw quiz JSON string
                console.log('Quiz JSON String:', quizJSON);

                // Parse the JSON string directly
                let parsedQuizData;
                try {
                    parsedQuizData = JSON.parse(quizJSON);
                    console.log('Parsed Quiz Data:', parsedQuizData);
                } catch (parseError) {
                    console.error('Error parsing quiz JSON:', parseError);
                    throw new Error('Failed to parse quiz questions. Please ensure the API returns valid JSON.');
                }

                // Validate the structure of parsedQuizData
                if (!parsedQuizData.questions || !Array.isArray(parsedQuizData.questions)) {
                    console.error('Invalid quiz data structure:', parsedQuizData);
                    throw new Error('Quiz data is not in the expected format.');
                }

                return parsedQuizData.questions;
            } catch (error) {
                console.error('Error generating quiz questions:', error);
                throw error;
            }
        }

         /**
         * Updated handleTranslateAndGo function to include the QA step.
         */
        async function handleTranslateAndGo() {
    const originalText = originalTextArea.value.trim();
    if (!originalText) {
        alert('Please paste text into the original text area.');
        return;
    }
    if (!apiKey) {
        alert('Please enter your API key.');
        apiKeyInput.style.display = 'block';
        toggleApiKeyButton.textContent = '[-]';
        return;
    }

    try {
        // Disable buttons during processing
        translateAndGoButton.disabled = true;
        useTestButton.disabled = true; // Disable test button during API calls

        // Make the initial API call to process and translate the text
        const processedData = await translateAndProcessText(originalText);

        // Perform Quality Assurance on the processed data
        const qaData = await qualityAssureTranslation(processedData);

        // Assign the QA-verified data to sentencePairs
        sentencePairs = qaData.sentences; // Updated assignment

        // Save texts to localStorage
        saveToLocalStorage(originalText); // Only original text is saved

        // Create the display
        createDisplay();

        // Initialize index and display the first pair
        currentIndex = 0;
        showSentence(currentIndex);

        // Show the display area and hide input area
        displayArea.style.display = 'block';
        inputArea.style.display = 'none';
    } catch (error) {
        alert('An error occurred during processing. Please try again.\n' + error.message);
    } finally {
        // Re-enable buttons
        translateAndGoButton.disabled = false;
        useTestButton.disabled = false; // Re-enable test button
    }
}

        /**
         * Function to create the display of all sentence pairs.
         * Each sentence pair is wrapped into lines and stored for display.
         */
        function createDisplay() {
            sentencesContainer.innerHTML = ''; // Clear previous content

            sentencePairs.forEach((pair, index) => {
                const sentenceDiv = document.createElement('div');
                sentenceDiv.classList.add('sentence-pair');
                sentenceDiv.id = `sentence-${index}`;

                // Create line pairs
                pair.lines.forEach(lineObj => {
                    const linePairDiv = document.createElement('div');
                    linePairDiv.classList.add('line-pair');

                    const originalLineDiv = document.createElement('div');
                    originalLineDiv.classList.add('original');
                    originalLineDiv.textContent = lineObj.original;

                    const translatedLineDiv = document.createElement('div');
                    translatedLineDiv.classList.add('translated');
                    translatedLineDiv.textContent = lineObj.translated;

                    // Add event listeners for spotlight effect
                    translatedLineDiv.addEventListener('mousemove', function(e) {
                        const rect = this.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;

                        this.style.setProperty('--x', `${x}px`);
                        this.style.setProperty('--y', `${y}px`);
                    });

                    translatedLineDiv.addEventListener('mouseleave', function() {
                        this.style.setProperty('--x', '-9999px');
                        this.style.setProperty('--y', '-9999px');
                    });

                    linePairDiv.appendChild(originalLineDiv);
                    linePairDiv.appendChild(translatedLineDiv);

                    sentenceDiv.appendChild(linePairDiv);
                });

                sentencesContainer.appendChild(sentenceDiv);
            });
        }

        /**
         * Function to display a specific sentence pair based on the current index.
         * Also fetches and displays quiz questions for the current sentence.
         * @param {number} index - The index of the sentence to display.
         */
        async function showSentence(index) {
            // Hide all sentence pairs
            const allSentencePairs = document.querySelectorAll('.sentence-pair');
            allSentencePairs.forEach(pair => pair.classList.remove('active-sentence'));

            if (index < sentencePairs.length) {
                // Show the current sentence pair
                const currentPair = document.getElementById(`sentence-${index}`);
                if (currentPair) {
                    currentPair.classList.add('active-sentence');
                }

                // Clear any existing quiz
                quizContainer.innerHTML = '';
                quizContainer.style.display = 'none';

                // Initialize attempt counts and correctness
                attemptCounts = [];
                correctAnswers = [];

                // Add a 'Generate Quiz' button
                const generateQuizButton = document.createElement('button');
                generateQuizButton.textContent = 'Generate Quiz';
                generateQuizButton.id = 'generateQuizButton';
                generateQuizButton.addEventListener('click', function() {
                    generateQuizForSentence(index);
                });
                quizContainer.appendChild(generateQuizButton);
                quizContainer.style.display = 'block';
            } else {
                // User has reached the end; extract words and phrases
                extractWordsAndPhrases(originalTextArea.value.trim())
                    .then(pairs => {
                        wordsAndPhrases = pairs;
                        displayWordsAndPhrases(wordsAndPhrases);
                    })
                    .catch(error => {
                        alert('An error occurred while extracting words and phrases.\n' + error.message);
                    });
            }
        }

        /**
         * Function to generate and display quiz questions for a specific sentence.
         * @param {number} index - The index of the sentence.
         */
        async function generateQuizForSentence(index) {
            const currentSentence = sentencePairs[index].lines.map(line => line.original).join(' ');

            try {
                // Show a loading indicator
                quizContainer.innerHTML = '<p>Loading quiz...</p>';
                quizContainer.style.display = 'block';

                // Fetch quiz questions from the API
                quizData = await getQuizQuestions(currentSentence);

                // Initialize attempt counts and correctness
                attemptCounts = new Array(quizData.length).fill(0);
                correctAnswers = new Array(quizData.length).fill(false);

                // Display the quiz
                displayQuiz(quizData);
            } catch (error) {
                alert('Failed to load quiz questions: ' + error.message);
                quizContainer.innerHTML = ''; // Clear any loading text
                quizContainer.style.display = 'none';
            }
        }

        /**
         * Function to display the quiz questions.
         * @param {Array} quizData - The quiz questions as an array.
         */
        function displayQuiz(quizData) {
            if (!quizData || !Array.isArray(quizData)) {
                console.error('Invalid quiz data provided to displayQuiz:', quizData);
                alert('Received invalid quiz data. Unable to display quiz.');
                quizContainer.style.display = 'none';
                return;
            }

            quizContainer.innerHTML = ''; // Clear previous content

            // Initialize attemptCounts and correctAnswers
            attemptCounts = new Array(quizData.length).fill(0);
            correctAnswers = new Array(quizData.length).fill(false);

            quizData.forEach((questionData, qIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('quiz-question');

                // Display the chunk being questioned (optional, for better context)
                const chunkDiv = document.createElement('div');
                chunkDiv.classList.add('quiz-chunk');
                chunkDiv.textContent = `Chunk: "${questionData.chunk}"`;
                questionDiv.appendChild(chunkDiv);

                // Display the question
                const questionText = document.createElement('p');
                questionText.textContent = questionData.question;
                questionDiv.appendChild(questionText);

                // Depending on the question type, render dropdown or input
                if (questionData.type === 'dropdown') {
                    const select = document.createElement('select');
                    select.id = `question-${qIndex}`;

                    // Add a default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select an option';
                    select.appendChild(defaultOption);

                    // Shuffle the answers to ensure the correct answer isn't always first
                    const shuffledAnswers = shuffleArray([...questionData.answers]);

                    // Add options to the dropdown
                    shuffledAnswers.forEach((answerObj) => {
                        const option = document.createElement('option');
                        option.value = answerObj.answer;
                        option.textContent = answerObj.answer;
                        select.appendChild(option);
                    });

                    questionDiv.appendChild(select);
                } else if (questionData.type === 'input') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `question-${qIndex}`;
                    questionDiv.appendChild(input);
                }

                // Add attempt indicator
                const attemptIndicator = document.createElement('div');
                attemptIndicator.classList.add('attempt-indicator');
                attemptIndicator.id = `attempt-${qIndex}`;
                attemptIndicator.textContent = `Attempts: 0/3`;
                questionDiv.appendChild(attemptIndicator);

                // Add translation if available
                if (questionData.question_translation) {
                    const translationP = document.createElement('p');
                    translationP.style.fontStyle = 'italic';
                    translationP.style.color = '#555';
                    translationP.textContent = `Translation: ${questionData.question_translation}`;
                    questionDiv.appendChild(translationP);
                }

                quizContainer.appendChild(questionDiv);
            });

            // Add a submit button
            const submitButton = document.createElement('button');
            submitButton.textContent = 'Submit Answers';
            submitButton.id = 'submitQuizButton';
            submitButton.addEventListener('click', checkQuizAnswers);
            quizContainer.appendChild(submitButton);

            // Show the quiz container
            quizContainer.style.display = 'block';
        }

        /**
         * Function to check the user's answers and provide feedback.
         */
        function checkQuizAnswers() {
            if (!quizData) return;

            let score = 0;
            let total = quizData.length;
            let allCompleted = true; // Flag to check if all questions are completed

            quizData.forEach((questionData, qIndex) => {
                const userAnswerElement = document.getElementById(`question-${qIndex}`);
                const attemptIndicator = document.getElementById(`attempt-${qIndex}`);
                let userAnswer;

                if (questionData.type === 'dropdown') {
                    userAnswer = userAnswerElement.value;
                } else if (questionData.type === 'input') {
                    userAnswer = userAnswerElement.value.trim();
                }

                // Skip if already answered correctly
                if (correctAnswers[qIndex]) {
                    return;
                }

                // Determine the correct answer(s)
                let correctAnswer = '';
                if (questionData.type === 'dropdown') {
                    // Find the answer with correct: true
                    const correctObj = questionData.answers.find(ans => ans.correct);
                    correctAnswer = correctObj ? correctObj.answer : '';
                } else if (questionData.type === 'input') {
                    // Assuming only one correct answer for input type
                    const correctObj = questionData.answers.find(ans => ans.correct);
                    correctAnswer = correctObj ? correctObj.answer : '';
                }

                // Compare user's answer with the correct answer
                let isCorrect = false;
                if (questionData.type === 'input') {
                    isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                } else {
                    isCorrect = userAnswer === correctAnswer;
                }

                if (isCorrect) {
                    score++;
                    correctAnswers[qIndex] = true;
                    userAnswerElement.style.border = '2px solid green';

                    // **Disable the control and set the correct answer**
                    if (questionData.type === 'dropdown') {
                        userAnswerElement.value = correctAnswer;
                        userAnswerElement.disabled = true;
                        // Update the selectedTranslations set
                        selectedTranslations.add(correctAnswer);
                        updateDropdownOptions();
                    } else if (questionData.type === 'input') {
                        userAnswerElement.value = correctAnswer;
                        userAnswerElement.disabled = true;
                    }
                } else {
                    attemptCounts[qIndex]++;
                    attemptIndicator.textContent = `Attempts: ${attemptCounts[qIndex]}/3`;

                    if (attemptCounts[qIndex] >=3) {
                        // Reveal correct answer
                        const correctAnswerText = document.createElement('div');
                        correctAnswerText.classList.add('correct-answer-text');
                        correctAnswerText.textContent = `Correct Answer: ${correctAnswer}`;
                        quizContainer.children[qIndex].appendChild(correctAnswerText);

                        // Highlight incorrect answer
                        userAnswerElement.style.border = '2px solid red';

                        // **Set correct answer and disable the control**
                        if (questionData.type === 'dropdown') {
                            userAnswerElement.value = correctAnswer;
                            userAnswerElement.disabled = true;
                            // Update the selectedTranslations set
                            selectedTranslations.add(correctAnswer);
                            updateDropdownOptions();
                        } else if (questionData.type === 'input') {
                            userAnswerElement.value = correctAnswer;
                            userAnswerElement.disabled = true;
                        }
                    } else {
                        // Highlight incorrect answer
                        userAnswerElement.style.border = '2px solid red';
                    }

                    allCompleted = false; // At least one question is not completed
                }
            });

            // Display the score if all questions are completed
            if (allCompleted) {
                const feedback = document.createElement('div');
                feedback.classList.add('feedback');
                feedback.textContent = `You scored ${score} out of ${total} correct!`;
                quizContainer.appendChild(feedback);

                // Disable the submit button to prevent multiple submissions
                const submitButton = document.getElementById('submitQuizButton');
                if (submitButton) {
                    submitButton.disabled = true;
                }
            } else {
                // Update feedback message
                let feedback = document.querySelector('.feedback');
                if (!feedback) {
                    feedback = document.createElement('div');
                    feedback.classList.add('feedback');
                    quizContainer.appendChild(feedback);
                }
                feedback.textContent = `You scored ${score} out of ${total} correct so far. Keep trying!`;
            }
        }
		
		/**
 * Function to perform Quality Assurance on the translated and processed text.
 * It ensures that:
 * 1. Each line in 'original' and 'translated' does not exceed 70 characters.
 * 2. Properly formats the translations.
 * 3. Pads the translated text with spaces if it's significantly shorter than the original.
 * 4. Maintains the original JSON structure for further processing.
 * 
 * @param {Array} processedData - The JSON array returned from the initial translation API call.
 * @returns {Promise<Array>} - The QA-verified and corrected JSON array.
 */
async function qualityAssureTranslation(processedData) {
    if (!apiKey) {
        throw new Error('API Key is missing. Please enter your API key.');
    }

    // API Endpoint (Same as the initial translation API)
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${apiKey}`;


    // System Instruction for Quality Assurance
    const systemInstruction = `
	
	Add translations for the lines.
	
    The line object ARRAY MUST HAVE:
	{
        "original": "",
		"translated"
	}
	
	replace n/a with the translation if there.
		
[
  sentences: {
    "sentenceID": 1,
    "lines": [
      {
        "original": "Ceci est la première phrase, qui rentre dans soixante-dix caractères",
        "translated": "This is the first sentence, which fits within seventy characters"
      }
    ]
  },
  {
    "sentenceID": 2,
    "lines": [
      {
        "original": "La deuxième phrase est beaucoup plus longue et doit être divisée sur",
        "translated": "The second sentence is quite a bit longer and needs to be split over"
      },
      {
        "original": "deux lignes pour tenir dans soixante-dix caractères",
        "translated": "two lines to fit within seventy characters"
      }
    ]
  },
  {
    "sentenceID": 3,
    "lines": [
      {
        "original": "Il est également important de noter que certaines phrases peuvent",
        "translated": "It is also important to note that some sentences may contain words or"
      },
      {
        "original": "contenir des mots ou des expressions plus complexes qui nécessitent",
        "translated": "expressions that are more complex and require special attention when"
      },
      {
        "original": "une attention particulière lors de la traduction.",
        "translated": "translating."
      }
    ]
  }
]



Provide the corrected JSON only, without any additional explanations or text.
    `;

    // Convert the processedData back to JSON string for the API to process
    const processedDataString = JSON.stringify(processedData, null, 2);

    // Construct the request payload for the QA API call
    const requestBody = {
        "contents": [
            {
                "role": "user",
                "parts": [
                    {
                        "text": processedDataString
                    }
                ]
            }
        ],
        "systemInstruction": {
            "role": "user",
            "parts": [
                {
                    "text": systemInstruction
                }
            ]
        },
        "generationConfig": {
            "temperature": 0.3, // Lower temperature for more deterministic output
            "topK": 40,
            "topP": 0.9,
            "maxOutputTokens": 2000, // Adjust as needed based on expected response size
            "responseMimeType": "application/json"
        }
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API Error: ${errorData.error.message}`);
        }

        const data = await response.json();

        // Extract the JSON response from the API
        const responseText = data.candidates[0].content.parts[0].text;

        // Parse the JSON string
        let correctedJSON;
        try {
            correctedJSON = JSON.parse(responseText);
            validateQAJSON(correctedJSON.sentences); // Updated validation
        } catch (parseError) {
            console.error('Error parsing QA JSON:', parseError);
            throw new Error('Failed to parse QA JSON response from API.');
        }

        return correctedJSON; // Returning the entire object
    } catch (error) {
        console.error('Error during Quality Assurance processing:', error);
        throw error;
    }
}

/**
 * Function to validate the QA JSON structure.
 * @param {Array} data - The QA JSON data to validate.
 */
function validateQAJSON(data) {
    if (!Array.isArray(data)) {
        throw new Error('QA JSON is not an array.');
    }

    data.forEach(pair => {
        if (typeof pair.sentenceID !== 'number') {
            throw new Error(`Invalid or missing sentenceID in pair: ${JSON.stringify(pair)}`);
        }

        if (!Array.isArray(pair.lines)) {
            throw new Error(`Lines should be an array in pair: ${JSON.stringify(pair)}`);
        }

        pair.lines.forEach(line => {
            if (typeof line.original !== 'string' || typeof line.translated !== 'string') {
                throw new Error(`Invalid line format in pair ID ${pair.sentenceID}: ${JSON.stringify(line)}`);
            }
        });
    });
}


        /**
         * Function to display the list of words and phrases.
         * @param {Array} pairs - The array of word and phrase pairs.
         */
        function displayWordsAndPhrases(pairs) {
            // Shuffle the pairs
            const shuffledPairs = shuffleArray([...pairs]);

            // Separate originals and translations
            const originals = pairs.map(pair => pair.split('|')[0].trim());
            const translations = shuffledPairs.map(pair => pair.split('|')[1].trim());

            // Clear previous content
            originalList.innerHTML = '';
            resultDiv.innerHTML = '';

            // Populate the original list with dropdowns
            originals.forEach((original, index) => {
                const originalItemDiv = document.createElement('div');
                originalItemDiv.classList.add('original-item');

                const originalLabel = document.createElement('label');
                originalLabel.setAttribute('for', `select-${index}`);
                originalLabel.textContent = original;

                const selectElement = document.createElement('select');
                selectElement.classList.add('select-translation');
                selectElement.id = `select-${index}`;
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select translation';
                selectElement.appendChild(defaultOption);

                // Add options to the dropdown
                translations.forEach((translation, tIndex) => {
                    const option = document.createElement('option');
                    option.value = translation;
                    option.textContent = translation;
                    selectElement.appendChild(option);
                });

                // Add event listener to handle selection changes
                selectElement.addEventListener('change', function(event) {
                    const previousSelection = selectElement.getAttribute('data-previous');
                    const currentSelection = event.target.value;

                    // If there was a previous selection, remove it from the selectedTranslations set
                    if (previousSelection) {
                        selectedTranslations.delete(previousSelection);
                    }

                    // If a new selection is made, add it to the selectedTranslations set
                    if (currentSelection) {
                        selectedTranslations.add(currentSelection);
                    }

                    // Update the 'data-previous' attribute
                    selectElement.setAttribute('data-previous', currentSelection);

                    // Update all dropdowns to reflect the new selections
                    updateDropdownOptions();
                });

                originalItemDiv.appendChild(originalLabel);
                originalItemDiv.appendChild(selectElement);

                originalList.appendChild(originalItemDiv);
            });

            // Show the container
            wordsPhrasesContainer.style.display = 'block';
            displayArea.style.display = 'none';
        }

        /**
         * Function to update the options in all dropdowns based on current selections.
         */
        function updateDropdownOptions() {
            // Iterate through each select element
            const selectElements = document.querySelectorAll('.select-translation');

            selectElements.forEach(select => {
                const currentValue = select.value;

                select.querySelectorAll('option').forEach(option => {
                    if (option.value === '') return; // Skip the default option

                    if (selectedTranslations.has(option.value) && option.value !== currentValue) {
                        option.disabled = true;
                        option.style.display = 'none'; // Optional: Hide disabled options
                    } else {
                        option.disabled = false;
                        option.style.display = 'block'; // Optional: Show enabled options
                    }
                });
            });
        }

        /**
         * Function to shuffle an array (Fisher-Yates algorithm).
         * @param {Array} array - The array to shuffle.
         * @returns {Array} - Shuffled array.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Handle the "Guess" button click event.
         */
        guessButton.addEventListener('click', function() {
            let correctCount = 0;
            const total = wordsAndPhrases.length;

            wordsAndPhrases.forEach((pair, index) => {
                const [original, translation] = pair.split('|').map(s => s.trim());
                const selectedTranslation = document.getElementById(`select-${index}`).value;

                const selectElement = document.getElementById(`select-${index}`);

                // Remove previous classes
                selectElement.classList.remove('correct');
                selectElement.classList.remove('incorrect');

                if (selectedTranslation === translation) {
                    correctCount++;
                    selectElement.classList.add('correct');
                    selectElement.style.backgroundColor = '#c8e6c9'; // Green background for correct
                    selectElement.disabled = true; // Disable the select after correct selection
                } else {
                    selectElement.classList.add('incorrect');
                    selectElement.style.backgroundColor = '#ffcdd2'; // Red background for incorrect
                }
            });

            resultDiv.textContent = `You got ${correctCount} out of ${total} correct!`;
        });

        /**
         * Handle the restart button click event.
         */
        restartButton.addEventListener('click', function() {
            // Reset the application to the initial state
            wordsPhrasesContainer.style.display = 'none';
            inputArea.style.display = 'block';
            currentIndex = 0;
            sentencePairs = [];
            wordsAndPhrases = [];
            quizData = null;
            attemptCounts = [];
            correctAnswers = [];
            originalTextArea.value = '';
            goButton.style.display = 'none'; // Hide Go button as it's no longer used
            translateAndGoButton.style.display = 'inline-block';
            useTestButton.style.display = 'inline-block'; // Show test button on restart
            originalList.innerHTML = '';
            resultDiv.innerHTML = '';
            quizContainer.innerHTML = '';
            quizContainer.style.display = 'none';

            // Clear the selectedTranslations set
            selectedTranslations.clear();
        });

        /**
         * Allow users to return to the input area by pressing the Escape key.
         */
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (wordsPhrasesContainer.style.display === 'block') {
                    // Hide the words and phrases container and show the input area
                    wordsPhrasesContainer.style.display = 'none';
                    inputArea.style.display = 'block';
                } else if (displayArea.style.display === 'block') {
                    // Hide the display area and show input area
                    displayArea.style.display = 'none';
                    inputArea.style.display = 'block';
                }
            }
        });

        /**
         * Handle keyboard navigation using Left and Right arrow keys.
         * Right Arrow: Next sentence
         * Left Arrow: Previous sentence
         */
        document.addEventListener('keydown', function(event) {
            // Only respond to arrow keys if the display area is visible
            if (displayArea.style.display !== 'block') return;

            if (event.key === 'ArrowRight') {
                // Move to the next sentence
                currentIndex++;
                showSentence(currentIndex);
                event.preventDefault(); // Prevent default scrolling
            } else if (event.key === 'ArrowLeft') {
                // Move to the previous sentence if not at the beginning
                if (currentIndex > 0) {
                    currentIndex--;
                    showSentence(currentIndex);
                }
                event.preventDefault(); // Prevent default scrolling
            }
        });

        /**
         * Handle navigation buttons click events.
         */
        prevButton.addEventListener('click', function() {
            if (currentIndex > 0) {
                currentIndex--;
                showSentence(currentIndex);
            }
        });

        nextButton.addEventListener('click', function() {
            currentIndex++;
            showSentence(currentIndex);
        });

        /**
         * Handle the API key input changes.
         */
        apiKeyInput.addEventListener('input', function() {
            apiKey = apiKeyInput.value.trim();
            localStorage.setItem('apiKey', apiKey); // Save API key to localStorage
        });

        /**
         * Handle the API key toggle button click event.
         */
        toggleApiKeyButton.addEventListener('click', function() {
            if (apiKeyInput.style.display === 'none') {
                apiKeyInput.style.display = 'block';
                toggleApiKeyButton.textContent = '[-]';
            } else {
                apiKeyInput.style.display = 'none';
                toggleApiKeyButton.textContent = '[+]';
            }
        });

        /**
         * Handle the "Use Test Sentences" button click event.
         */
        useTestButton.addEventListener('click', handleUseTestSentences);

        // Attach event listeners to the buttons
        translateAndGoButton.addEventListener('click', handleTranslateAndGo);
    </script>
</body>
</html>
