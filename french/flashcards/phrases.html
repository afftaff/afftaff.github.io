<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>French Phrase Decks</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --french-bg: #e0f2fe;
      --french-border: #7dd3fc;
      --literal-bg: #fef3c7;
      --literal-border: #fbbf24;
      --translation-bg: #f1f5f9;
      --accent: #6366f1;
      --accent-dark: #4338ca;
      --shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, sans-serif;
      background: var(--bg);
      color: var(--ink);
      display: flex;
      justify-content: center;
      padding: 32px 16px 48px;
    }

    .app {
      width: min(980px, 100%);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .controls {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow);
    }

    .controls label {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .controls select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 1rem;
      min-width: 180px;
    }

    .pill {
      background: #eef2ff;
      color: var(--accent-dark);
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 28px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .speaker {
      width: 62px;
      height: 62px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: white;
      font-size: 1.8rem;
      cursor: pointer;
      display: grid;
      place-items: center;
      box-shadow: 0 12px 24px rgba(67, 56, 202, 0.25);
      transition: transform 0.15s ease;
    }

    .speaker:active {
      transform: scale(0.96);
    }

    .phrase-line {
      display: grid;
      grid-template-columns: repeat(var(--token-count), minmax(40px, max-content));
      gap: 10px;
      align-items: center;
    }

    .token-group {
      padding: 6px 10px;
      border-radius: 999px;
      border: 2px solid transparent;
      font-weight: 600;
      cursor: pointer;
      min-height: 40px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s ease, border-color 0.2s ease;
      user-select: none;
      justify-content: center;
    }

    .token-word {
      padding: 2px 4px;
      border-radius: 6px;
      color: transparent;
      transition: color 0.1s ease;
    }

    .token-group.revealed .token-word {
      color: var(--ink);
    }

    .token-group.french {
      background: var(--french-bg);
      border-color: var(--french-border);
    }

    .token-group.english {
      background: var(--translation-bg);
      border-color: var(--border);
    }

    .phrase-line.locked {
      opacity: 0.6;
      pointer-events: none;
    }

    .translation {
      background: var(--translation-bg);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      font-weight: 600;
      color: transparent;
      cursor: pointer;
      transition: color 0.2s ease;
      min-height: 52px;
      display: flex;
      align-items: center;
    }

    .translation.revealed {
      color: var(--ink);
    }

    .translation::before {
      content: attr(data-placeholder);
      color: var(--muted);
      font-weight: 500;
    }

    .translation.revealed::before {
      content: "";
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .segment-control {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f8fafc;
      overflow: hidden;
    }

    .segment-btn {
      border: none;
      background: transparent;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--muted);
      transition: background 0.2s ease, color 0.2s ease;
    }

    .segment-btn.active {
      background: var(--accent);
      color: white;
    }

    .reveal-all-btn {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .rate-btn {
      flex: 1 1 120px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-weight: 600;
      cursor: pointer;
      background: white;
      transition: transform 0.1s ease, border-color 0.2s ease;
    }

    .rate-btn:active {
      transform: scale(0.98);
    }

    .rate-btn.again { border-color: #fecaca; background: #fee2e2; color: #991b1b; }
    .rate-btn.hard { border-color: #fed7aa; background: #ffedd5; color: #9a3412; }
    .rate-btn.good { border-color: #bae6fd; background: #e0f2fe; color: #0c4a6e; }
    .rate-btn.easy { border-color: #bbf7d0; background: #dcfce7; color: #166534; }

    .status {
      font-size: 0.95rem;
      color: var(--muted);
    }

    @media (max-width: 720px) {
      .card {
        padding: 20px;
      }

      .phrase-line {
        gap: 6px;
      }

      .token-group {
        min-height: 34px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="controls">
      <div>
        <label for="deckSelect">Deck</label><br>
        <select id="deckSelect" aria-label="Select deck"></select>
      </div>
      <div>
        <label>Token size</label><br>
        <div class="segment-control" role="group" aria-label="Token size">
          <button class="segment-btn active" type="button" data-size="1">1 word</button>
          <button class="segment-btn" type="button" data-size="3">3 word</button>
          <button class="segment-btn" type="button" data-size="5">5 word</button>
        </div>
      </div>
      <span class="pill" id="deckLabel">Deck</span>
      <span class="pill" id="deckProgress">0 / 0</span>
      <span class="status" id="statusText">Loading phrasesâ€¦</span>
    </div>

    <div class="card">
      <button class="speaker" id="speakBtn" aria-label="Hear phrase">ðŸ”Š</button>
      <div class="phrase-line" id="frenchLine" style="--token-count: 1"></div>
      <div class="phrase-line locked" id="englishTokens" style="--token-count: 1"></div>
      <button class="reveal-all-btn" id="revealFrenchBtn" type="button">Reveal French sentence</button>
      <div class="translation" id="englishLine" data-placeholder="Click to reveal the full translation"></div>
    </div>

    <div class="actions">
      <button class="rate-btn again" data-rating="again">Again</button>
      <button class="rate-btn hard" data-rating="hard">Hard</button>
      <button class="rate-btn good" data-rating="good">Good</button>
      <button class="rate-btn easy" data-rating="easy">Easy</button>
    </div>
  </div>

  <script>
    const CSV_PATH = "../dir/words/1000frenchphrases.csv";
    const DECK_SIZE = 50;

    const els = {
      deckSelect: document.getElementById("deckSelect"),
      deckLabel: document.getElementById("deckLabel"),
      deckProgress: document.getElementById("deckProgress"),
      statusText: document.getElementById("statusText"),
      frenchLine: document.getElementById("frenchLine"),
      englishTokens: document.getElementById("englishTokens"),
      revealFrenchBtn: document.getElementById("revealFrenchBtn"),
      englishLine: document.getElementById("englishLine"),
      speakBtn: document.getElementById("speakBtn"),
      rateButtons: document.querySelectorAll(".rate-btn"),
      segmentButtons: document.querySelectorAll(".segment-btn")
    };

    const synth = window.speechSynthesis;
    let voice = null;

    const state = {
      decks: [],
      deckIndex: 0,
      queue: [],
      finished: [],
      tokenSize: 1,
      revealStage: "french",
      frenchRevealed: [],
      englishRevealed: []
    };

    function splitWords(text) {
      if (!text) return [];
      return text
        .trim()
        .split(/\s+/)
        .filter(Boolean);
    }

    function loadVoices() {
      const voices = synth.getVoices();
      voice =
        voices.find((v) => v.lang.toLowerCase().startsWith("fr")) ||
        voices.find((v) => v.lang.toLowerCase().includes("fr")) ||
        null;
    }

    function speak(text) {
      if (!text) return;
      loadVoices();
      synth.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "fr-FR";
      if (voice) utter.voice = voice;
      synth.speak(utter);
    }

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      const data = [];
      for (let i = 1; i < lines.length; i += 1) {
        const line = lines[i].trim();
        if (!line) continue;
        const [french, english, literal] = line.split("|").map((part) => part?.trim() || "");
        if (!french) continue;
        data.push({
          french,
          english: english || "",
          literal: literal || ""
        });
      }
      return data;
    }

    function buildDecks(entries) {
      const decks = [];
      for (let i = 0; i < entries.length; i += DECK_SIZE) {
        const slice = entries.slice(i, i + DECK_SIZE);
        decks.push({
          label: `Deck ${decks.length + 1} (${slice.length})`,
          entries: slice
        });
      }
      return decks;
    }

    function refreshDeckSelect() {
      els.deckSelect.innerHTML = "";
      state.decks.forEach((deck, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = deck.label;
        els.deckSelect.appendChild(option);
      });
      els.deckSelect.value = String(state.deckIndex);
    }

    function setDeck(index) {
      state.deckIndex = Math.max(0, Math.min(index, state.decks.length - 1));
      const deck = state.decks[state.deckIndex];
      state.queue = deck ? [...deck.entries] : [];
      state.finished = [];
      els.deckLabel.textContent = deck ? deck.label : "No deck";
      updateProgress();
      renderCard();
    }

    function updateProgress() {
      const total = state.queue.length + state.finished.length;
      const completed = state.finished.length;
      els.deckProgress.textContent = `${Math.min(completed + 1, total)} / ${total}`;
      els.statusText.textContent = total
        ? `${completed} completed, ${state.queue.length} in review.`
        : "No phrases available.";
    }

    function groupWords(words, size) {
      if (!words.length) return [];
      const groups = [];
      for (let i = 0; i < words.length; i += size) {
        groups.push(words.slice(i, i + size));
      }
      return groups;
    }

    function renderTokenLine(container, groups, type, revealed, onGroupClick) {
      container.innerHTML = "";
      const totalSlots = groups.length || 1;
      container.style.setProperty("--token-count", totalSlots);
      if (!groups.length) {
        const placeholder = document.createElement("span");
        placeholder.className = `token-group ${type}`;
        container.appendChild(placeholder);
        return;
      }

      groups.forEach((group, index) => {
        const groupEl = document.createElement("span");
        groupEl.className = `token-group ${type}`;
        if (revealed[index]) groupEl.classList.add("revealed");
        group.forEach((word) => {
          const wordEl = document.createElement("span");
          wordEl.className = "token-word";
          wordEl.textContent = word;
          groupEl.appendChild(wordEl);
        });
        groupEl.addEventListener("click", () => onGroupClick(index, groupEl));
        container.appendChild(groupEl);
      });
    }
    }

    function renderCard() {
      const current = state.queue[0];
      if (!current) {
        els.frenchLine.innerHTML = "";
        els.englishTokens.innerHTML = "";
        els.englishLine.textContent = "";
        els.englishLine.dataset.placeholder = "Deck finished â€” pick another deck.";
        els.englishLine.classList.remove("revealed");
        els.englishTokens.classList.add("locked");
        return;
      }

      const frenchWords = splitWords(current.french);
      const englishWords = splitWords(current.english);
      const frenchGroups = groupWords(frenchWords, state.tokenSize);
      const englishGroups = groupWords(englishWords, state.tokenSize);

      state.revealStage = "french";
      state.frenchRevealed = new Array(frenchGroups.length).fill(false);
      state.englishRevealed = new Array(englishGroups.length).fill(false);

      renderTokenLine(els.frenchLine, frenchGroups, "french", state.frenchRevealed, (index, groupEl) => {
        if (state.revealStage !== "french") return;
        state.frenchRevealed[index] = !state.frenchRevealed[index];
        groupEl.classList.toggle("revealed", state.frenchRevealed[index]);
        if (state.frenchRevealed.every(Boolean)) {
          state.revealStage = "english";
          els.englishTokens.classList.remove("locked");
        }
      });

      renderTokenLine(els.englishTokens, englishGroups, "english", state.englishRevealed, (index, groupEl) => {
        if (state.revealStage !== "english") return;
        state.englishRevealed[index] = !state.englishRevealed[index];
        groupEl.classList.toggle("revealed", state.englishRevealed[index]);
      });

      els.englishTokens.classList.add("locked");
      els.englishLine.textContent = current.english || "";
      els.englishLine.dataset.placeholder = "Click to reveal the full translation";
      els.englishLine.classList.remove("revealed");
      updateProgress();
    }

    function rateCard(rating) {
      if (!state.queue.length) return;
      const card = state.queue.shift();
      if (rating === "easy") {
        state.finished.push(card);
      } else {
        const insertMap = { again: 2, hard: 5, good: 10 };
        const offset = insertMap[rating] ?? 3;
        const index = Math.min(offset, state.queue.length);
        state.queue.splice(index, 0, card);
      }
      renderCard();
    }

    els.englishLine.addEventListener("click", () => {
      els.englishLine.classList.toggle("revealed");
    });

    els.revealFrenchBtn.addEventListener("click", () => {
      if (state.revealStage !== "french") return;
      state.frenchRevealed = state.frenchRevealed.map(() => true);
      els.frenchLine.querySelectorAll(".token-group").forEach((group) => {
        group.classList.add("revealed");
      });
      state.revealStage = "english";
      els.englishTokens.classList.remove("locked");
    });

    els.segmentButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        els.segmentButtons.forEach((button) => button.classList.remove("active"));
        btn.classList.add("active");
        state.tokenSize = Number(btn.dataset.size) || 1;
        renderCard();
      });
    });

    els.speakBtn.addEventListener("click", () => {
      const current = state.queue[0];
      if (current) speak(current.french);
    });

    els.rateButtons.forEach((btn) => {
      btn.addEventListener("click", () => rateCard(btn.dataset.rating));
    });

    els.deckSelect.addEventListener("change", (event) => {
      setDeck(Number(event.target.value));
    });

    synth.onvoiceschanged = loadVoices;
    loadVoices();

    fetch(CSV_PATH)
      .then((res) => res.text())
      .then((text) => {
        const entries = parseCsv(text);
        state.decks = buildDecks(entries);
        refreshDeckSelect();
        setDeck(0);
      })
      .catch(() => {
        els.statusText.textContent = "Unable to load phrases.";
      });
  </script>
</body>
</html>
