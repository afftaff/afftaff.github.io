<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Temporary French Flashcards</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0b1120;
      --panel: #0f172a;
      --accent: #22c55e;
      --accent-2: #38bdf8;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --border: #1f2937;
      --card: linear-gradient(145deg, #111827, #0f172a);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Poppins', system-ui, sans-serif;
      background: radial-gradient(circle at 15% 20%, rgba(34,197,94,0.10), transparent 30%),
                  radial-gradient(circle at 85% 0%, rgba(56,189,248,0.12), transparent 30%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 24px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(15,23,42,0.8);
      position: sticky;
      top: 0;
      backdrop-filter: blur(8px);
      z-index: 2;
    }
    header a { color: var(--muted); text-decoration: none; font-weight: 600; }
    header a:hover { color: var(--text); }
    main { max-width: 1200px; margin: 0 auto; padding: 28px; display: grid; gap: 18px; grid-template-columns: 2fr 1fr; }
    @media (max-width: 1024px) { main { grid-template-columns: 1fr; } }
    h1 { margin: 0 0 10px; letter-spacing: -0.02em; }
    p { margin: 0; color: var(--muted); }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    .panel header { padding: 0; border: none; background: none; position: static; backdrop-filter: none; }
    .panel header h2 { margin: 0 0 6px; }
    .panel header p { margin: 0; }

    .field { margin-bottom: 14px; }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"] {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 12px 14px;
      background: #0b1224;
      color: var(--text);
      font-size: 15px;
    }
    input[type="text"]::placeholder { color: #64748b; }
    button.primary {
      border: none;
      background: linear-gradient(135deg, var(--accent), #16a34a);
      color: #0b1120;
      padding: 12px 14px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }
    button.secondary {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      padding: 12px 14px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }
    button.ghost {
      border: 1px dashed var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    .deck-list { display: grid; gap: 12px; margin-top: 16px; }
    .word-row {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      background: #0b1224;
      display: grid;
      gap: 6px;
    }
    .word-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .word-head h3 { margin: 0; font-size: 20px; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: rgba(56,189,248,0.12); border: 1px solid rgba(56,189,248,0.35); color: #bae6fd; font-weight: 600; font-size: 13px; }
    .tags { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .definition-list { margin: 8px 0 0; padding-left: 18px; color: var(--text); }
    .definition-list li { margin-bottom: 4px; }
    .muted { color: var(--muted); font-size: 14px; }

    .card-shell { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 18px; }
    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 20px 20px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 16px 40px rgba(0,0,0,0.35);
      min-height: 260px;
      position: relative;
      overflow: hidden;
      display: grid;
      gap: 12px;
    }
    .card .label { font-size: 12px; letter-spacing: 0.05em; color: var(--muted); text-transform: uppercase; }
    .card .prompt { font-size: 36px; margin: 0; }
    .card .ipa { color: var(--muted); font-weight: 600; }
    .card .defs { color: var(--text); }
    .card .defs li { margin-bottom: 6px; }
    .card .hint { color: var(--muted); font-size: 13px; }
    .stack-meta { display: flex; align-items: center; justify-content: space-between; color: var(--muted); margin-top: 10px; }
    .sound-btn { border: 1px solid var(--border); background: rgba(255,255,255,0.06); color: var(--text); padding: 8px 10px; border-radius: 8px; cursor: pointer; display: inline-flex; gap: 6px; align-items: center; }

    .status { margin-top: 8px; color: var(--muted); min-height: 20px; }
    .notice { padding: 10px 12px; border-radius: 10px; background: rgba(56,189,248,0.08); border: 1px solid rgba(56,189,248,0.35); color: #bae6fd; }
  </style>
</head>
<body>
  <header>
    <div>
      <div style="font-weight:700;">Temporary French Flashcards</div>
      <small style="color: var(--muted);">Ad-hoc deck built from live Wiktionary lookups</small>
    </div>
    <a href="./index.html">‚Üê Back to menu</a>
  </header>
  <main>
    <section class="panel" aria-labelledby="builder-heading">
      <header>
        <h1 id="builder-heading">Build your deck</h1>
        <p>Add any French word or expression. We will fetch IPA, audio (when available), and definitions from Wiktionary.</p>
      </header>
      <form id="addForm" class="field" autocomplete="off">
        <label for="wordInput">French word</label>
        <div class="actions">
          <input id="wordInput" name="word" type="text" placeholder="e.g. √©tudier" required />
          <button type="submit" class="primary">Add to deck</button>
        </div>
      </form>
      <div class="actions" style="margin: 10px 0 4px;">
        <button id="startDeck" class="secondary" disabled>Play deck</button>
        <button id="clearDeck" class="ghost" disabled>Clear all</button>
        <span class="muted" id="countLabel"></span>
      </div>
      <div class="status" id="status"></div>
      <div id="deckList" class="deck-list" aria-live="polite"></div>
    </section>

    <section class="panel" aria-labelledby="quiz-heading">
      <header>
        <h2 id="quiz-heading">Quiz</h2>
        <p>Cards are shown in random order. Tap to flip and reveal definitions.</p>
      </header>
      <div class="card-shell">
        <div class="card" id="quizCard" aria-live="polite">
          <div class="label">Prompt</div>
          <h3 class="prompt" id="cardWord">Add some words to begin</h3>
          <div class="ipa" id="cardIpa"></div>
          <div class="hint" id="cardPos"></div>
          <div class="defs" id="cardDefs"></div>
          <div class="actions">
            <button class="sound-btn" id="playAudio" disabled>üîä Hear pronunciation</button>
            <button class="sound-btn" id="flipCard" disabled>‚ü≥ Flip</button>
            <button class="sound-btn" id="nextCard" disabled>Next ‚Üí</button>
          </div>
          <div class="stack-meta" id="stackMeta"></div>
        </div>
      </div>
      <p class="notice">Audio comes from Wiktionary when available. If none exists, the site falls back to your browser's French text-to-speech voice.</p>
    </section>
  </main>

  <script>
    const storageKey = 'tempFrenchFlashcards-v1';
    const statusEl = document.getElementById('status');
    const deckListEl = document.getElementById('deckList');
    const wordInput = document.getElementById('wordInput');
    const startDeckBtn = document.getElementById('startDeck');
    const clearDeckBtn = document.getElementById('clearDeck');
    const countLabel = document.getElementById('countLabel');
    const playAudioBtn = document.getElementById('playAudio');
    const flipBtn = document.getElementById('flipCard');
    const nextBtn = document.getElementById('nextCard');
    const cardWord = document.getElementById('cardWord');
    const cardIpa = document.getElementById('cardIpa');
    const cardDefs = document.getElementById('cardDefs');
    const cardPos = document.getElementById('cardPos');
    const stackMeta = document.getElementById('stackMeta');

    let deck = loadDeck();
    let quizQueue = [];
    let quizIndex = 0;
    let showingBack = false;

    function loadDeck() {
      try {
        const raw = localStorage.getItem(storageKey);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (err) {
        console.error('Failed to parse deck', err);
        return [];
      }
    }

    function saveDeck() {
      localStorage.setItem(storageKey, JSON.stringify(deck));
      renderDeck();
    }

    function setStatus(message, tone = 'muted') {
      statusEl.textContent = message;
      statusEl.style.color = tone === 'error' ? '#fca5a5' : 'var(--muted)';
    }

    function renderDeck() {
      deckListEl.innerHTML = '';
      if (!deck.length) {
        deckListEl.innerHTML = '<p class="muted">No words yet. Add a French word to start building your deck.</p>';
        startDeckBtn.disabled = true;
        clearDeckBtn.disabled = true;
        countLabel.textContent = '';
        return;
      }

      deck.forEach((entry, index) => {
        const row = document.createElement('article');
        row.className = 'word-row';
        const head = document.createElement('div');
        head.className = 'word-head';
        const title = document.createElement('h3');
        title.textContent = entry.term;
        const meta = document.createElement('div');
        meta.className = 'tags';
        if (entry.ipa) {
          const pill = document.createElement('span');
          pill.className = 'pill';
          pill.textContent = entry.ipa;
          meta.appendChild(pill);
        }
        if (entry.partOfSpeech) {
          const pill = document.createElement('span');
          pill.className = 'pill';
          pill.textContent = entry.partOfSpeech;
          meta.appendChild(pill);
        }
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'ghost';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', () => {
          deck.splice(index, 1);
          saveDeck();
          setStatus(`Removed ‚Äú${entry.term}‚Äù`);
        });
        head.append(title, meta, deleteBtn);
        row.appendChild(head);

        const defList = document.createElement('ul');
        defList.className = 'definition-list';
        (entry.definitions || []).forEach(def => {
          const li = document.createElement('li');
          li.textContent = def;
          defList.appendChild(li);
        });
        if (!entry.definitions || !entry.definitions.length) {
          const empty = document.createElement('p');
          empty.className = 'muted';
          empty.textContent = 'No definitions found.';
          row.appendChild(empty);
        } else {
          row.appendChild(defList);
        }
        deckListEl.appendChild(row);
      });

      startDeckBtn.disabled = false;
      clearDeckBtn.disabled = false;
      countLabel.textContent = `${deck.length} card${deck.length === 1 ? '' : 's'}`;
    }

    async function fetchJson(url) {
      const response = await fetch(url, { headers: { accept: 'application/json' } });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response.json();
    }

    function cleanWikiText(text) {
      if (!text) return '';
      let cleaned = text
        .replace(/^#\s*/, '')
        .replace(/{{[^{}]*}}/g, '')
        .replace(/\[\[([^\]|]+)\|([^\]]+)\]\]/g, '$2')
        .replace(/\[\[([^\]]+)\]\]/g, '$1')
        .replace(/''+/g, '')
        .replace(/\(\s*\)/g, '')
        .replace(/\s+/g, ' ')
        .trim();
      return cleaned;
    }

    function extractFrenchSection(content) {
      const match = content.match(/==French==([\s\S]*?)(\n==[^=]|$)/);
      return match ? match[1] : '';
    }

    function parsePartOfSpeech(section) {
      const posMatch = section.match(/===([^=]+)===/);
      return posMatch ? posMatch[1].trim() : '';
    }

    function parseIpa(section) {
      const ipaMatch = section.match(/{{IPA\|fr\|([^}|]+)\|?/);
      if (ipaMatch) return ipaMatch[1].replace(/\//g, '').trim();
      const frIpaMatch = section.match(/\/(?:[^\n\/]{2,})\//);
      return frIpaMatch ? frIpaMatch[0].replace(/\//g, '') : '';
    }

    function parseDefinitions(section) {
      const defs = [];
      const lines = section.split('\n');
      lines.forEach(line => {
        if (line.startsWith('# ') && !line.startsWith('#:')) {
          const cleaned = cleanWikiText(line);
          if (cleaned) defs.push(cleaned);
        }
      });
      return defs;
    }

    async function lookupWiktionary(term) {
      const normalized = term.trim();
      if (!normalized) throw new Error('Please provide a word.');

      const url = `https://en.wiktionary.org/w/api.php?action=query&prop=revisions&rvprop=content&rvslots=main&format=json&titles=${encodeURIComponent(normalized)}&origin=*`;
      const data = await fetchJson(url);
      const page = data?.query?.pages ? Object.values(data.query.pages)[0] : null;
      const raw = page?.revisions?.[0]?.slots?.main?.['*'] || page?.revisions?.[0]?.['*'];
      if (!raw) throw new Error('No Wiktionary entry found.');

      const frenchSection = extractFrenchSection(raw);
      if (!frenchSection) throw new Error('No French entry found on Wiktionary.');

      const definitions = parseDefinitions(frenchSection);
      if (!definitions.length) throw new Error('No definitions found in French entry.');

      return {
        term: normalized,
        ipa: parseIpa(frenchSection),
        audio: '',
        partOfSpeech: parsePartOfSpeech(frenchSection),
        definitions
      };
    }

    document.getElementById('addForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const term = wordInput.value.trim();
      if (!term) return;
      setStatus('Looking up Wiktionary‚Ä¶');
      try {
        const existing = deck.find(d => d.term.toLowerCase() === term.toLowerCase());
        if (existing) throw new Error('That word is already in your deck.');
        const card = await lookupWiktionary(term);
        deck.push(card);
        saveDeck();
        setStatus(`Added ‚Äú${card.term}‚Äù with ${card.definitions.length || 'no'} definitions.`);
        wordInput.value = '';
      } catch (err) {
        console.error(err);
        setStatus(err.message || 'Lookup failed. Please try again.', 'error');
      }
    });

    startDeckBtn.addEventListener('click', () => {
      if (!deck.length) return;
      quizQueue = shuffle([...deck]);
      quizIndex = 0;
      showingBack = false;
      flipBtn.disabled = false;
      nextBtn.disabled = false;
      playAudioBtn.disabled = false;
      renderQuizCard();
    });

    clearDeckBtn.addEventListener('click', () => {
      if (!deck.length) return;
      deck = [];
      saveDeck();
      setStatus('Cleared deck.');
      resetQuiz();
    });

    flipBtn.addEventListener('click', () => {
      if (!quizQueue.length) return;
      showingBack = !showingBack;
      renderQuizCard();
    });

    nextBtn.addEventListener('click', () => {
      if (!quizQueue.length) return;
      quizIndex = (quizIndex + 1) % quizQueue.length;
      showingBack = false;
      renderQuizCard();
    });

    playAudioBtn.addEventListener('click', () => {
      if (!quizQueue.length) return;
      const current = quizQueue[quizIndex];
      if (current.audio) {
        const audio = new Audio(current.audio);
        audio.play();
      } else if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(current.term);
        utterance.lang = 'fr-FR';
        speechSynthesis.speak(utterance);
      }
    });

    function renderQuizCard() {
      if (!quizQueue.length) {
        cardWord.textContent = 'Add some words to begin';
        cardIpa.textContent = '';
        cardDefs.innerHTML = '';
        cardPos.textContent = '';
        stackMeta.textContent = '';
        flipBtn.disabled = true;
        nextBtn.disabled = true;
        playAudioBtn.disabled = true;
        return;
      }
      const card = quizQueue[quizIndex];
      cardWord.textContent = card.term;
      cardIpa.textContent = card.ipa ? `/${card.ipa}/` : '';
      cardPos.textContent = card.partOfSpeech || '';
      stackMeta.textContent = `${quizIndex + 1} / ${quizQueue.length}`;
      if (showingBack) {
        const list = document.createElement('ul');
        list.className = 'defs';
        (card.definitions && card.definitions.length ? card.definitions : ['No definition available']).forEach(def => {
          const li = document.createElement('li');
          li.textContent = def;
          list.appendChild(li);
        });
        cardDefs.innerHTML = '';
        cardDefs.appendChild(list);
      } else {
        cardDefs.innerHTML = '<p class="hint">Flip to reveal definitions.</p>';
      }
    }

    function resetQuiz() {
      quizQueue = [];
      quizIndex = 0;
      showingBack = false;
      renderQuizCard();
    }

    function shuffle(list) {
      const copy = [...list];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    renderDeck();
    renderQuizCard();
  </script>
</body>
</html>
