<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>French Missing Verb Flashcards</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #0b1120;
      --accent: #10b981;
      --muted: #9ca3af;
      --border: #1f2937;
      --shadow: 0 20px 60px rgba(0,0,0,0.35);
      --radius: 14px;
    }
    * { box-sizing: border-box; outline-color: var(--accent); }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(16,185,129,0.08), transparent 30%),
                  radial-gradient(circle at 80% 0%, rgba(59,130,246,0.08), transparent 30%),
                  var(--bg);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 24px;
      gap: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: rgba(15,23,42,0.7);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      backdrop-filter: blur(8px);
      z-index: 10;
    }
    h1 { margin: 0; font-family: 'Playfair Display', serif; letter-spacing: -0.01em; }
    header a { color: var(--muted); text-decoration: none; font-weight: 600; }
    header a:hover { color: var(--accent); }

    main {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      align-items: start;
    }
    @media (max-width: 960px) { main { grid-template-columns: 1fr; } }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }
    label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95rem; }
    textarea, input, select, button {
      font-family: 'Inter', sans-serif;
    }
    textarea, input, select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: #e5e7eb;
      padding: 10px 12px;
    }
    textarea { min-height: 140px; resize: vertical; }

    .btn-row { display: flex; gap: 10px; margin-top: 10px; }
    button {
      border-radius: 10px;
      border: 1px solid var(--accent);
      background: transparent;
      color: #e5e7eb;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
      flex: 1;
      transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
    }
    button.primary { background: var(--accent); color: #0b1120; }
    button:hover { transform: translateY(-1px); border-color: #34d399; }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .pill {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .pill small { color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
    .pill strong { font-size: 1.2rem; }

    .card-area { display: flex; flex-direction: column; gap: 14px; }
    .flashcard {
      background: linear-gradient(145deg, #0b1224, #0d1429);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      min-height: 320px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--shadow);
    }
    .question { font-size: 1.1rem; line-height: 1.6; }
    select.answer { width: auto; margin-top: 8px; }
    .options { background: rgba(255,255,255,0.02); border-radius: 12px; padding: 12px; border: 1px dashed var(--border); }
    .translation { color: var(--muted); font-style: italic; }
    .feedback { font-weight: 700; }

    .queue-controls { display: flex; gap: 8px; flex-wrap: wrap; }
    .queue-controls button { flex: 1 1 140px; }

    .log { font-family: 'Inter', sans-serif; font-size: 0.85rem; color: var(--muted); white-space: pre-wrap; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Missing Verb Flashcards</h1>
      <div style="color:var(--muted);">Cloze practice powered by Gemini</div>
    </div>
    <a href="./index.html">‚Üê Back to menu</a>
  </header>

  <main>
    <section class="panel">
      <label for="apiKey">Google AI Studio API Key</label>
      <div class="btn-row" style="margin-top:6px;">
        <input type="password" id="apiKey" placeholder="AIza..." />
        <button id="saveKey" style="flex:0 0 auto; width:90px;">Save</button>
      </div>
      <small style="color:var(--muted);">Stored locally in your browser.</small>

      <div style="margin-top:16px;">
        <label for="sourceText">Paste sentences (punctuation optional)</label>
        <textarea id="sourceText" placeholder="Tu dois terminer ton travail avant de sortir Tu devras..." ></textarea>
      </div>

      <div class="btn-row">
        <button class="secondary" id="cleanBtn">Clean text with AI</button>
        <button class="primary" id="buildBtn">Build deck</button>
      </div>
      <button class="secondary" id="clearBtn" style="margin-top:8px; width:100%;">Reset</button>

      <div class="status">
        <div class="pill">
          <small>Sentences</small>
          <strong id="sentenceCount">0</strong>
        </div>
        <div class="pill">
          <small>In deck</small>
          <strong id="deckCount">0</strong>
        </div>
        <div class="pill">
          <small>Remaining</small>
          <strong id="remaining">0</strong>
        </div>
      </div>

      <div class="pill" style="margin-top:12px;">
        <small>Status</small>
        <div id="statusText" class="log">Awaiting input‚Ä¶</div>
      </div>
    </section>

    <section class="card-area">
      <div class="flashcard" id="card">
        <div class="question" id="question">Paste text and click Build deck to start.</div>
        <div class="options" id="options"></div>
        <select id="answerSelect" class="answer" style="display:none;"></select>
        <button class="primary" id="checkBtn" style="width: fit-content; display:none;">Check answer</button>
        <div class="feedback" id="feedback"></div>
        <div class="translation" id="translation"></div>
        <div class="queue-controls" id="queueButtons" style="display:none;">
          <button id="againBtn">Again (reshuffle top)</button>
          <button id="mediumBtn">Medium (middle)</button>
          <button id="easyBtn">Easy (later)</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const dom = {
      apiKey: document.getElementById('apiKey'),
      saveKey: document.getElementById('saveKey'),
      source: document.getElementById('sourceText'),
      cleanBtn: document.getElementById('cleanBtn'),
      buildBtn: document.getElementById('buildBtn'),
      clearBtn: document.getElementById('clearBtn'),
      sentenceCount: document.getElementById('sentenceCount'),
      deckCount: document.getElementById('deckCount'),
      remaining: document.getElementById('remaining'),
      statusText: document.getElementById('statusText'),
      question: document.getElementById('question'),
      options: document.getElementById('options'),
      select: document.getElementById('answerSelect'),
      checkBtn: document.getElementById('checkBtn'),
      feedback: document.getElementById('feedback'),
      translation: document.getElementById('translation'),
      queueButtons: document.getElementById('queueButtons'),
      againBtn: document.getElementById('againBtn'),
      mediumBtn: document.getElementById('mediumBtn'),
      easyBtn: document.getElementById('easyBtn')
    };

    const cleaningInstruction = "I'll give you some text without punctuation and can you fix them in to sentences please. Do not say anything, just return the fixed text.";
    const missingVerbInstruction = `I say:\nTu dois terminer ton travail avant de sortir ?\n\nYOU REPLY IN THIS FORMAT ONLY!! Choose first verb!\n[\nTu ____ terminer ton travail avant de sortir ?\n| dois (Indicatif ‚Äì Pr√©sent)\n| devais (Indicatif ‚Äì Imparfait)\n| devras (Indicatif ‚Äì Futur simple)\n| as d√ª (Indicatif ‚Äì Pass√© compos√©)\n| avais d√ª (Indicatif ‚Äì Plus-que-parfait)\n| auras d√ª (Indicatif ‚Äì Futur ant√©rieur)\n| dus (Indicatif ‚Äì Pass√© simple)\n| eus d√ª (Indicatif ‚Äì Pass√© ant√©rieur)\n| doives (Subjonctif ‚Äì Pr√©sent)\n| aies d√ª (Subjonctif ‚Äì Pass√©)\n| dusses (Subjonctif ‚Äì Imparfait)\n| eusses d√ª (Subjonctif ‚Äì Plus-que-parfait)\n| devrais (Conditionnel ‚Äì Pr√©sent)\n| aurais d√ª (Conditionnel ‚Äì Pass√©)\n| dois (Imp√©ratif)\n| devant (Participe pr√©sent)\n| d√ª (Participe pass√©)\n<Dois>\n**Tu dois terminer ton travail avant de sortir? (Do you have to finish your work before going out?)**\n]`;

    const state = {
      queue: [],
      cards: [],
      pendingCard: null
    };

    function saveKey() {
      const val = dom.apiKey.value.trim();
      if (!val) { alert('Enter an API key first.'); return; }
      localStorage.setItem('geminiKey', val);
      dom.statusText.textContent = 'API key saved locally.';
    }

    function loadKey() {
      const saved = localStorage.getItem('geminiKey');
      if (saved && !dom.apiKey.value) dom.apiKey.value = saved;
      return dom.apiKey.value.trim();
    }
    loadKey();

    function setStatus(msg) { dom.statusText.textContent = msg; }

    function splitSentences(text) {
      return text
        .split(/[.!?]/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function updateCounters() {
      dom.sentenceCount.textContent = `${state.cards.length}`;
      dom.deckCount.textContent = `${state.cards.length}`;
      dom.remaining.textContent = `${state.queue.length}`;
    }

    async function callGemini(systemInstruction, userContent) {
      const key = loadKey();
      if (!key) throw new Error('Missing API key');
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-lite-latest:generateContent?key=${key}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          systemInstruction: { parts: [{ text: systemInstruction }] },
          contents: [{ parts: [{ text: userContent }] }]
        })
      });
      const raw = await response.text();
      let data;
      try { data = JSON.parse(raw); } catch (e) { data = null; }
      if (!response.ok || data?.error) {
        const err = new Error(data?.error?.message || `Request failed (${response.status})`);
        err.raw = raw;
        throw err;
      }
      const botText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!botText) throw new Error('No content returned.');
      return botText;
    }

    async function cleanText() {
      const input = dom.source.value.trim();
      if (!input) { alert('Paste some text first.'); return; }
      setStatus('Cleaning text‚Ä¶');
      dom.cleanBtn.disabled = dom.buildBtn.disabled = true;
      try {
        const cleaned = await callGemini(cleaningInstruction, input);
        dom.source.value = cleaned.trim();
        setStatus('Cleaned text inserted. You can build the deck now.');
      } catch (err) {
        console.error(err);
        setStatus(`Clean-up failed: ${err.message}`);
      } finally {
        dom.cleanBtn.disabled = dom.buildBtn.disabled = false;
      }
    }

    function parseMissingVerbResponse(text) {
      const bracketMatch = text.match(/\[(.*)\]/s);
      const content = (bracketMatch ? bracketMatch[1] : text).trim();
      const lines = content.split(/\n+/).map(l => l.trim()).filter(Boolean);
      const question = lines.find(l => l.includes('____')) || lines[0] || '';
      const options = lines.filter(l => l.startsWith('|')).map(l => l.replace(/^\|\s*/, ''));
      const answerLine = lines.find(l => /^<.*>$/.test(l)) || '';
      const translationLine = lines.find(l => /^\*\*.*\*\*$/.test(l)) || '';
      const correct = answerLine.replace(/[<>]/g, '').trim();
      const translation = translationLine.replace(/\*\*/g, '').trim();
      return { question, options, correct, translation };
    }

    async function buildCard(sentence, index, total) {
      setStatus(`Building card ${index + 1}/${total}‚Ä¶`);
      const response = await callGemini(missingVerbInstruction, sentence);
      const parsed = parseMissingVerbResponse(response);
      if (!parsed.question || !parsed.options.length || !parsed.correct) throw new Error('Could not parse card.');
      return { sentence, ...parsed };
    }

    async function buildDeck() {
      const input = dom.source.value.trim();
      if (!input) { alert('Paste some text first.'); return; }
      const sentences = splitSentences(input);
      if (!sentences.length) { alert('No sentences detected.'); return; }
      dom.buildBtn.disabled = dom.cleanBtn.disabled = true;
      dom.feedback.textContent = '';
      dom.translation.textContent = '';
      dom.select.style.display = 'none';
      dom.checkBtn.style.display = 'none';
      dom.options.innerHTML = '';
      dom.queueButtons.style.display = 'none';
      dom.checkBtn.disabled = false;
      state.cards = [];
      state.queue = [];
      updateCounters();
      try {
        for (let i = 0; i < sentences.length; i++) {
          const card = await buildCard(sentences[i], i, sentences.length);
          state.cards.push(card);
        }
        state.queue = [...state.cards];
        setStatus('Deck ready.');
        updateCounters();
        renderCard();
      } catch (err) {
        console.error(err);
        setStatus(`Error building deck: ${err.message}`);
      } finally {
        dom.buildBtn.disabled = dom.cleanBtn.disabled = false;
        updateCounters();
      }
    }

    function renderCard() {
      dom.feedback.textContent = '';
      dom.translation.textContent = '';
      dom.queueButtons.style.display = 'none';
      const current = state.queue[0];
      if (!current) {
        dom.question.textContent = 'Deck complete!';
        dom.options.innerHTML = '';
        dom.select.style.display = 'none';
        dom.checkBtn.style.display = 'none';
        updateCounters();
        return;
      }
      dom.question.textContent = current.question;
      dom.options.innerHTML = current.options.map(opt => `<div>${opt}</div>`).join('');
      dom.select.style.display = 'block';
      dom.checkBtn.style.display = 'inline-block';
      dom.select.innerHTML = '<option value="">Select the missing verb‚Ä¶</option>' + current.options.map(opt => {
        const [verb] = opt.split(' ');
        return `<option value="${verb}">${verb}</option>`;
      }).join('');
      updateCounters();
    }

    function checkAnswer() {
      const current = state.queue[0];
      if (!current) return;
      const choice = dom.select.value.trim();
      if (!choice) { alert('Choose an option first.'); return; }
      const isCorrect = choice.toLowerCase() === current.correct.toLowerCase();
      dom.translation.textContent = current.translation || '';
      dom.feedback.textContent = isCorrect ? 'Correct! üéâ' : `Not quite. Correct answer: ${current.correct}`;
      state.pendingCard = isCorrect ? null : state.queue.shift();
      dom.checkBtn.disabled = true;
      if (isCorrect) {
        state.queue.shift();
        renderCard();
      } else {
        dom.queueButtons.style.display = 'flex';
        updateCounters();
      }
    }

    function requeue(mode) {
      if (!state.pendingCard) return;
      const card = state.pendingCard;
      state.pendingCard = null;
      const queue = state.queue;
      let position = queue.length;
      if (mode === 'again') position = Math.max(0, Math.min(1, queue.length));
      else if (mode === 'medium') position = Math.floor(queue.length / 2);
      queue.splice(position, 0, card);
      dom.queueButtons.style.display = 'none';
      renderCard();
    }

    function clearAll() {
      dom.source.value = '';
      state.queue = [];
      state.cards = [];
      dom.select.innerHTML = '';
      dom.options.innerHTML = '';
      dom.feedback.textContent = '';
      dom.translation.textContent = '';
      dom.queueButtons.style.display = 'none';
      dom.question.textContent = 'Paste text and click Build deck to start.';
      updateCounters();
      setStatus('Awaiting input‚Ä¶');
    }

    dom.saveKey.addEventListener('click', saveKey);
    dom.cleanBtn.addEventListener('click', cleanText);
    dom.buildBtn.addEventListener('click', buildDeck);
    dom.clearBtn.addEventListener('click', clearAll);
    dom.checkBtn.addEventListener('click', checkAnswer);
    dom.select.addEventListener('change', () => { dom.feedback.textContent = ''; dom.translation.textContent = ''; });
    dom.againBtn.addEventListener('click', () => requeue('again'));
    dom.mediumBtn.addEventListener('click', () => requeue('medium'));
    dom.easyBtn.addEventListener('click', () => requeue('easy'));

    // Checking answer by selecting option and pressing Enter
    dom.select.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); checkAnswer(); }
    });
    // Dedicated click anywhere on options to evaluate
    dom.options.addEventListener('click', (e) => {
      if (e.target.tagName === 'DIV') {
        const verb = e.target.textContent.split(' ')[0];
        dom.select.value = verb;
        checkAnswer();
      }
    });
  </script>
</body>
</html>
